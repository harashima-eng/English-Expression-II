<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Grammar Breakdown 14ï½œUltraLite v4 (Full Virtualization)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    :root{
  /* iOS Notes-like neutral grays */
  --bg:#f2f3f5;            /* page gray */
  --bg-card:#ffffff;      /* note paper */
  --text:#111827;         /* near-black */
  --text-soft:#6b7280;    /* iOS secondary label-ish */

  --accent:#4f46e5;       /* keep your purple for labels */
  --accent-soft: rgba(79,70,229,.07);

  --border:#e2e5ea;       /* hairline gray */
  --hint:#2563eb; 
  --answer:#16a34a; 
  --warn:#f59e0b;

  --shadow:0 1px 4px rgba(15,23,42,.05);
  --shell-shadow:0 6px 18px rgba(15,23,42,.12);

  --radius:20px;
  --ease:cubic-bezier(.16,1,.3,1);
  --speed-fast:.10s; --speed:.16s; --speed-slow:.22s;
}
    body.dark{
  --bg:#0b0d12;           /* notes dark paper */
  --bg-card:#121621;
  --text:#e5e7eb;
  --text-soft:#9ca3af;

  --accent:#8a93ff;
  --accent-soft: rgba(138,147,255,.12);

  --border:#1a2030;
  --shadow:0 2px 8px rgba(0,0,0,.5);
  --shell-shadow:0 8px 20px rgba(0,0,0,.65);
}
    @media (prefers-reduced-motion: reduce){
      *{transition:none !important;animation:none !important;scroll-behavior:auto !important;}
    }
    body{
      font-family: system-ui, -apple-system, "SF Pro Text","Segoe UI","Hiragino Kaku Gothic ProN","Yu Gothic", sans-serif;
      background: linear-gradient(180deg,#0a0c10 0%, #05070a 100%);
      color:var(--text); padding:12px; min-height:100vh;
      scroll-behavior:smooth;
    }
    .shell{
      max-width:1120px; margin:0 auto; background:var(--bg);
      border-radius:20px; overflow:hidden;
      border:1px solid rgba(148,163,184,.35);
      box-shadow:var(--shell-shadow);
      transform:translateY(3px); opacity:0;
      animation:shellIn .35s var(--ease) forwards;
    }
    @keyframes shellIn{to{transform:translateY(0);opacity:1;}}
    header{
      color:#e5e7eb; padding:16px 16px;
      border-bottom:1px solid rgba(148,163,184,.28);
      display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;
      position:sticky; top:0; z-index:20;
      background: linear-gradient(135deg, rgba(2,6,23,.98), rgba(30,64,175,.96));
    }
    header h1{font-size:1.12rem;letter-spacing:.015em;}
    header .sub{font-size:.82rem;color:#cbd5f5;}
    .btn{
      cursor:pointer;border:none;outline:none; padding:8px 13px;border-radius:999px;
      font-size:.82rem;font-weight:800; letter-spacing:.015em;
      display:inline-flex;align-items:center;gap:6px;
      background:rgba(9,13,27,.94); color:#e5e7eb;
      border:1px solid rgba(148,163,184,.55);
      transition:transform var(--speed-fast) var(--ease), background var(--speed-fast) var(--ease), border var(--speed-fast) var(--ease);
      will-change:transform;
    }
    .btn:active{transform:translateY(1px) scale(.98);}
    .btn.ghost{background:transparent;color:var(--text);border-color:var(--border);}
    @media (hover:hover){
      .btn:hover{background:rgba(30,64,175,.98);transform:translateY(-1px);}
      .btn.ghost:hover{background:rgba(79,70,229,.055);border-color:var(--accent);}
      .q-item:hover{transform:translateY(-1px);}
      .mini:hover{transform:translateY(-1px);background:rgba(79,70,229,.055);border-color:var(--accent);}
      .qa-box:hover{border-color:rgba(79,70,229,.55);background:rgba(79,70,229,.02);}
    }
    .topbar{
      padding:8px 10px; background:var(--bg);
      border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;
      font-size:.8rem;color:var(--text-soft);
    }
    main{ padding:12px; }
    .section{
      border:0.7px solid var(--border);
      background:var(--bg-card);
      border-radius:14px; padding:12px; margin-bottom:12px;
      contain: layout paint;
    }
    .section h2{
      font-size:.96rem;
      display:flex;align-items:center;justify-content:space-between;
      margin-bottom:6px;
    }
    .tag{
      font-size:.7rem;padding:2px 9px;border-radius:999px;background:rgba(79,70,229,.055);
      color:var(--accent);font-weight:800;
      border:1px solid rgba(79,70,229,.20);
    }
    .q-item{
      padding:12px 12px 14px; margin-top:10px;
      border-top:0.7px dashed rgba(148,163,184,.45);
      border-radius:12px; position:relative;
      background:var(--bg-card);
      box-shadow:var(--shadow);
      transition:transform var(--speed-fast) var(--ease);
      will-change:transform;
      contain: content;
    }
    .q-item:first-of-type{border-top:none;margin-top:0;}
    .q-label{font-weight:900;color:var(--accent);font-size:.9rem;margin-bottom:4px;}
    .q-jp{font-size:.88rem;color:var(--text-soft);margin-bottom:3px;}
    .q-en{font-size:1rem;line-height:1.82;}
    .q-raw{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
      font-size:.86rem;background:rgba(15,23,42,.05);
      padding:6px 7px;border-radius:8px;margin-top:6px; white-space:pre-wrap; line-height:1.6;
      border:0.7px solid var(--border);
    }
    .toggle-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px;}
    .mini{
      cursor:pointer;border:none;outline:none; padding:6px 11px;border-radius:999px;
      font-size:.78rem;font-weight:900; letter-spacing:.015em;
      display:inline-flex;align-items:center;gap:6px;
      transition:transform var(--speed-fast) var(--ease), background var(--speed-fast) var(--ease), border var(--speed-fast) var(--ease);
      border:0.7px solid var(--border);
      background:transparent;color:var(--text);
      will-change:transform;
    }
    .mini.hint{border-color:rgba(37,99,235,.35);}
    .mini.answer{border-color:rgba(22,163,74,.35);}
    .mini.warn{border-color:rgba(245,158,11,.5);}

    .accordion{
      display:grid; grid-template-rows:0fr;
      transition:grid-template-rows var(--speed-slow) var(--ease);
    }
    .accordion.open{grid-template-rows:1fr;}
    .accordion-inner{
      overflow:hidden;
      opacity:0; transform:translateY(-3px);
      transition:opacity var(--speed) var(--ease), transform var(--speed) var(--ease);
    }
    .accordion.open .accordion-inner{opacity:1; transform:translateY(0);}

    .ex{ margin-top:8px;display:grid;gap:8px; }
    .bubble{
      border-radius:12px;padding:10px 12px;
      border-left:5px solid transparent; background:rgba(15,23,42,.03);
      font-size:.98rem;line-height:1.82;
    }
    .bubble .label{font-weight:900;font-size:.78rem;letter-spacing:.05em;margin-bottom:5px;}
    .bubble.hint{ border-left-color:var(--hint); background:rgba(37,99,235,.06); }
    .bubble.answer{ border-left-color:var(--answer); background:rgba(22,163,74,.06); }
    .bubble.warn{ border-left-color:var(--warn); background:rgba(245,158,11,.08); }
    .bubble .jp{color:var(--text-soft);font-size:.85rem;margin-top:5px;}

    .qa-split{margin-top:8px;display:grid; grid-template-columns:1fr 1fr; gap:8px;}
    @media(max-width:720px){ .qa-split{grid-template-columns:1fr;} }
    .qa-box{
      background:transparent;border:1.4px solid var(--border);border-radius:12px;
      padding:7px 9px 9px;position:relative;contain:layout paint;
      transition:border var(--speed-fast) var(--ease), background var(--speed-fast) var(--ease);
    }
    .qa-box::before{
      content:""; position:absolute; left:9px; right:9px; top:0;
      height:3px; border-radius:999px; background:var(--border);
    }
    .qa-box.hint::before{ background:linear-gradient(90deg,var(--hint),transparent); }
    .qa-box.answer::before{ background:linear-gradient(90deg,var(--answer),transparent); }
    .qa-head{display:flex;align-items:center;justify-content:space-between;gap:6px;font-size:.82rem;font-weight:900;padding-top:4px;}
    .qa-body{ margin-top:6px; font-size:.98rem; line-height:1.82; }
    .qa-body .jp{color:var(--text-soft);font-size:.85rem;margin-top:5px;}

    .hintless-note{
      display:inline-flex;align-items:center;gap:6px;
      font-size:.76rem;font-weight:800;color:var(--warn);
      background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.28);
      padding:2px 7px;border-radius:999px;margin-left:6px;
    }

    .q-placeholder{
      margin-top:10px;
      border-radius:12px;
      position:relative;
      overflow:hidden;
      background:
        linear-gradient(180deg, rgba(15,23,42,.015), rgba(15,23,42,.03)),
        linear-gradient(90deg, transparent, rgba(79,70,229,.06), transparent);
      border:0.7px solid var(--border);
      padding:12px;
      min-height:120px;
      display:grid;
      gap:10px;
      align-content:center;
      color:var(--text-soft);
      font-size:.82rem;
    }
    .q-placeholder .sk-line{
      height:10px;border-radius:999px;
      background:rgba(15,23,42,.06);
    }
    .q-placeholder .sk-line.wide{width:88%;}
    .q-placeholder .sk-line.mid{width:64%;}
    .q-placeholder .sk-line.short{width:40%;}
    .q-placeholder .sk-chip{
      width:90px;height:20px;border-radius:999px;
      background:rgba(79,70,229,.10);
      border:1px solid rgba(79,70,229,.18);
    }
    /* super-light shimmer */
    .q-placeholder::after{
      content:"";
      position:absolute; inset:0;
      background:linear-gradient(100deg, transparent 30%, rgba(255,255,255,.5) 50%, transparent 70%);
      transform:translateX(-120%);
      animation: shimmer 1.8s linear infinite;
      will-change: transform;
      pointer-events:none;
      opacity:.6;
    }
    body.dark .q-placeholder::after{
      background:linear-gradient(100deg, transparent 30%, rgba(129,140,248,.22) 50%, transparent 70%);
      opacity:.8;
    }
    @keyframes shimmer{to{transform:translateX(120%);}}
    @media (prefers-reduced-motion: reduce){
      .q-placeholder::after{animation:none;}
    }
  
    /* Freeze heavy paint during active scroll (perf win) */
    body.scrolling .q-item,
    body.scrolling .qa-box,
    body.scrolling .bubble,
    body.scrolling .q-placeholder{
      box-shadow:none !important;
      transition:none !important;
    }
    body.scrolling .q-placeholder::after{ animation:none !important; opacity:0.2 !important; }

  </style>
</head>

<body>
<div class="shell">
  <header>
    <div>
      <h1>14 å¦å®šãƒ»ç‰¹æ®Šæ§‹æ–‡ï½œGrammar Breakdown</h1>
      <div class="sub">UltraLite v4 â€” full question virtualization (windowing) + answer on click</div>
    </div>
    <div style="display:flex;gap:6px;flex-wrap:wrap;">
      <button class="btn" id="themeBtn">ğŸŒ— Light / Dark</button>
      <button class="btn" id="modeBtn">ğŸ…°ï¸ Mode A</button>
      <button class="btn ghost" id="collapseAllBtn">ğŸ§¹ Close all</button>
      <button class="btn" id="downloadBtn">ğŸ’¾ Download HTML</button>
    </div>
  </header>

  <div class="topbar">
    <div id="modeDesc">Mode A: stacked Hint/Answer accordions.</div>
    <div>Full virtualization ON.</div>
  </div>

  <main id="contentRoot">

    <!-- SECTIONS / QUESTIONS (same DOM shells, content unchanged) -->
    <div class="section" data-sec="1">
      <h2>åŸºæœ¬å•é¡Œï¼‘ï½œèªå¥è£œå…… <span class="tag">Negation Basics</span></h2>
      <div class="q-item" data-qid="b1-1"><div class="q-label">(1)</div><div class="q-jp">ç§ãŸã¡ã®ä¼šç¤¾ã§å½¼ãŒè¾è·ã™ã‚‹ã“ã¨ã‚’çŸ¥ã£ã¦ã„ã‚‹äººã¯ã»ã¨ã‚“ã©ã„ãªã„ï¼</div><div class="q-en">(ã€€ã€€ã€€ã€€ã€€) people in our office know he is going to resign.</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="b1-2"><div class="q-label">(2)</div><div class="q-jp">ã‚«ã‚ºãƒ¤ã¯ãƒ”ã‚¢ãƒãŒä¸Šæ‰‹ã§ã™ï¼</div><div class="q-en">Kazuya is a (ã€€ã€€ã€€ã€€ã€€) (ã€€ã€€ã€€ã€€ã€€).</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="b1-3"><div class="q-label">(3)</div><div class="q-jp">ã‚‚ã—ãƒ‡ã‚£ãƒƒã‚¯ãŒãã®ç¥­ã‚Šã«è¡Œã‹ãªã„ã®ãªã‚‰ï¼Œåƒ•ã‚‚è¡Œã‹ãªã„ã‚ˆï¼</div><div class="q-en">If Dick doesnâ€™t go to the festival, I wonâ€™t, (ã€€ã€€ã€€ã€€ã€€).</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="b1-4"><div class="q-label">(4)</div><div class="q-jp">ä¼‘æš‡ä¸­ã¯ã‚ˆããŠä¼‘ã¿ã«ãªã‚Œã¾ã—ãŸã‹ï¼</div><div class="q-en">Did you have a (ã€€ã€€ã€€ã€€ã€€) (ã€€ã€€ã€€ã€€ã€€) during the holidays?</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="b1-5"><div class="q-label">(5)</div><div class="q-jp">ãã®ä½œå®¶ã¯ã‚ã£ãŸã«äººå‰ã«å§¿ã‚’è¦‹ã›ãªã„ï¼</div><div class="q-en">The writer (ã€€ã€€ã€€ã€€ã€€) appears in public.</div><div class="mode-slot"></div></div>
    </div>

    <div class="section" data-sec="2">
      <h2>åŸºæœ¬å•é¡Œï¼’ï½œæ›¸ãã‹ãˆ <span class="tag">Structures</span></h2>
      <div class="q-item" data-qid="b2-1"><div class="q-label">(1)</div><div class="q-en">Ben is most unlikely to betray us.<br>Ben would be (ã€€ã€€ã€€ã€€ã€€) (ã€€ã€€ã€€ã€€ã€€) person to betray us.</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="b2-2"><div class="q-label">(2)</div><div class="q-en">Some people are sure that ghosts exist.<br>Some people are sure of the (ã€€ã€€ã€€ã€€ã€€) (ã€€ã€€ã€€ã€€ã€€) ghosts.</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="b2-3"><div class="q-label">(3)</div><div class="q-en">I donâ€™t like any of these pictures.<br>I like (ã€€ã€€ã€€ã€€ã€€) (ã€€ã€€ã€€ã€€ã€€) these pictures.</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="b2-4"><div class="q-label">(4)</div><div class="q-en">Why did he change his mind?<br>What (ã€€ã€€ã€€ã€€ã€€) (ã€€ã€€ã€€ã€€ã€€) change his mind?</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="b2-5"><div class="q-label">(5)</div><div class="q-en">What you are saying is only an armchair theory.<br>What you are saying is (ã€€ã€€ã€€ã€€ã€€) (ã€€ã€€ã€€ã€€ã€€) an armchair theory.</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="b2-6"><div class="q-label">(6)</div><div class="q-en">Though they were tired, they went on working late.<br>(ã€€ã€€ã€€ã€€ã€€) (ã€€ã€€ã€€ã€€ã€€) they were, they went on working late.</div><div class="mode-slot"></div></div>
    </div>

    <div class="section" data-sec="3">
      <h2>åŸºæœ¬å•é¡Œï¼“ï½œè‹±â†’æ—¥ <span class="tag">Translation</span></h2>
      <div class="q-item" data-qid="b3-1"><div class="q-label">(1)</div><div class="q-en">I often go to the library, and so does my brother.</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="b3-2"><div class="q-label">(2)</div><div class="q-en">You should not despise people because they are not rich.</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="b3-3"><div class="q-label">(3)</div><div class="q-en">When angry, count to ten before you speak.</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="b3-4"><div class="q-label">(4)</div><div class="q-en">We have no choice but to wait for him here.</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="b3-5"><div class="q-label">(5)</div><div class="q-en">This computer can save us time and energy.</div><div class="mode-slot"></div></div>
    </div>

    <div class="section" data-sec="4">
      <h2>åŸºæœ¬å•é¡Œï¼”ï½œä¸¦ã¹ã‹ãˆ <span class="tag">Word Order</span></h2>
      <div class="q-item" data-qid="b4-1"><div class="q-label">(1)</div><div class="q-jp">ã‚‚ã£ã¨æ—©ãã«è‡ªå·±ç´¹ä»‹ã‚’ã—ãªãã¦ã™ã¿ã¾ã›ã‚“ï¼</div><div class="q-raw">Iâ€™m [ not, sooner, for, introducing, sorry, myself ].</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="b4-2"><div class="q-label">(2)</div><div class="q-jp">ã‚·ãƒ³ãƒ‡ãƒ¬ãƒ©ãŒèˆè¸ä¼šã§ã¯ã„ã¦ã„ãŸã®ã¯ã“ã®ã‚¬ãƒ©ã‚¹ã®é´ã ã£ãŸï¼</div><div class="q-raw">It [ Cinderella, glass slipper, that, this, was, wore ] at the ball.</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="b4-3"><div class="q-label">(3)</div><div class="q-jp">ç§ã¯ã‚‚ã¯ã‚„ãã®å¯’ã•ã«ã¯è€ãˆã‚‰ã‚Œãªã„ï¼</div><div class="q-raw">I [ the, any, stand, cold, longer, cannot ].</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="b4-4"><div class="q-label">(4)</div><div class="q-jp">ã‚ãªãŸã®ç€ã¦ã„ã‚‹Tã‚·ãƒ£ãƒ„ã‚’è¦‹ã‚‹ã¨ï¼Œè‡ªåˆ†ã®å›½ã‚’æ€ã„å‡ºã™ï¼</div><div class="q-raw">Your T-shirt [ of, my, me, country, reminds ].</div><div class="mode-slot"></div></div>
    </div>

    <div class="section" data-sec="5">
      <h2>åŸºæœ¬å•é¡Œï¼•ï½œè‹±ä½œ <span class="tag">Production</span></h2>
      <div class="q-item" data-qid="b5-1"><div class="q-label">(1)</div><div class="q-jp">ãã®å¥¨å­¦é‡‘ã®ãŠã‹ã’ã§å½¼ã¯å¤§å­¦ã«è¡Œãã“ã¨ãŒã§ããŸï¼</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="b5-2"><div class="q-label">(2)</div><div class="q-jp">ç§ã¯ã“ã‚“ãªç¾ã—ã„æ™¯è‰²ã‚’ã“ã‚Œã¾ã§è¦‹ãŸã“ã¨ãŒãªã„ï¼</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="b5-3"><div class="q-label">(3)</div><div class="q-jp">å½¼å¥³ã®æ‰‹ç´™ã«ã‚ˆã‚‹ã¨ï¼Œå½¼å¥³ã¯æ¥é€±æ—¥æœ¬ã«å¸°ã£ã¦ãã‚‹ãã†ã ï¼</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="b5-4"><div class="q-label">(4)</div><div class="q-jp">ç§ã®çˆ¶ã¯ã‚¿ãƒã‚³ã‚’å¸ã‚ãªã„ã—ï¼Œç§ã‚‚å¸ã‚ãªã„ï¼</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="b5-5"><div class="q-label">(5)</div><div class="q-jp">å½¼ã‚‰ãŒçµå©šã™ã‚‹ã¨ã„ã†ã†ã‚ã•ã‚’è€³ã«ã—ã¾ã—ãŸã‹ï¼</div><div class="mode-slot"></div></div>
    </div>

    <div class="section" data-sec="6">
      <h2>FOR COMMUNICATION <span class="tag">ä¼šè©±è¡¨ç¾</span></h2>
      <div class="q-item" data-qid="fc-1"><div class="q-label">(1)</div><div class="q-en">A: Whatâ€™s the matter? Are you hurt?<br>B: Yes, I slipped on the floor. I think my left arm is broken.<br>A: Oh! (ã€€ã€€ã€€).<br>a. I hope so / b. I hope not / c. Iâ€™m sorry not / d. Iâ€™m afraid not</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="fc-2"><div class="q-label">(2)</div><div class="q-en">A: Ken and Mary are getting married next week.<br>B: (ã€€ã€€ã€€)! They got to know each other just a week ago!<br>a. No kidding / b. No offense / c. No problem / d. No sweat</div><div class="mode-slot"></div></div>
    </div>

    <div class="section" data-sec="7">
      <h2>ç™ºå±•å•é¡Œï¼‘ï½œèªå¥é¸æŠ <span class="tag">å¤§å­¦å…¥è©¦</span></h2>
      <div class="q-item" data-qid="a1-1"><div class="q-label">(1)</div><div class="q-en">The accident I had yesterday was (ã€€ã€€ã€€) my control.<br>a. in / b. out / c. over / d. beyond</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="a1-2"><div class="q-label">(2)</div><div class="q-en">Susan is not a researcher and she is not a professor, (ã€€ã€€ã€€).<br>a. too / b. either / c. instead / d. also</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="a1-3"><div class="q-label">(3)</div><div class="q-en">The new tax system is (ã€€ã€€ã€€) but perfect.<br>a. anything / b. something / c. nothing / d. everything</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="a1-4"><div class="q-label">(4)</div><div class="q-en">The Internet has (ã€€ã€€ã€€) us to quickly contact even friends who are far away.<br>a. let / b. made / c. suggested / d. enabled</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="a1-5"><div class="q-label">(5)</div><div class="q-en">The food the restaurant offered us was (ã€€ã€€ã€€) from satisfying.<br>a. almost / b. close / c. all / d. far</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="a1-6"><div class="q-label">(6)</div><div class="q-en">How in the (ã€€ã€€ã€€) did you get this rare vase?<br>a. space / b. world / c. air / d. cloud</div><div class="mode-slot"></div></div>
    </div>

    <div class="section" data-sec="8">
      <h2>ç™ºå±•å•é¡Œï¼’ï½œä¸¦ã¹ã‹ãˆ <span class="tag">Emphasis etc.</span></h2>
      <div class="q-item" data-qid="a2-1"><div class="q-label">(1)</div><div class="q-jp">ã‚ãªãŸãŒãŠå…„ã•ã‚“ã‹ã‚‰ä¾¿ã‚Šã‚’ã‚‚ã‚‰ã£ãŸã®ã¯ã„ã¤ã§ã™ã‹ï¼</div><div class="q-raw">When [ from, heard, it, that, was, you ] your brother?</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="a2-2"><div class="q-label">(2)</div><div class="q-jp">ãã®è©±ã‚’èãã¨ã„ã¤ã‚‚å½¼ã®ã“ã¨ã‚’æ€ã„å‡ºã—ã¾ã™ï¼</div><div class="q-raw">I [ that, never, hear, without, story, remembering ] him.</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="a2-3"><div class="q-label">(3)</div><div class="q-jp">é›¢ã‚Œã¦ã¿ã¦åˆã‚ã¦è‡ªåˆ†ã®å›½ã®ã‚ˆã„ã¨ã“ã‚ãŒã‚ã‹ã‚‹ï¼</div><div class="q-raw">You [ leave, appreciate, you, donâ€™t, until, your own country ] it.</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="a2-4"><div class="q-label">(4)</div><div class="q-jp">å°‘ã—è€ƒãˆã‚Œã°ã‚ãªãŸã¯è‡ªåˆ†ãŒé–“é•ã£ã¦ã„ã‚‹ã“ã¨ã«æ°—ã¥ãã ã‚ã†ï¼</div><div class="q-raw">[ will make, a little, realize, you, reflection ] you are wrong.</div><div class="mode-slot"></div></div>
    </div>

    <div class="section" data-sec="9">
      <h2>ç™ºå±•å•é¡Œï¼“ï½œè‹±ä½œ <span class="tag">Output</span></h2>
      <div class="q-item" data-qid="a3-1"><div class="q-label">(1)</div><div class="q-jp">å¹é›ªã®ãŸã‚ã«å½¼å¥³ã¯å­¦æ ¡ã¸è¡Œã‘ãªã‹ã£ãŸï¼</div><div class="mode-slot"></div></div>
      <div class="q-item" data-qid="a3-2"><div class="q-label">(2)</div><div class="q-jp">ç§ã¯ãã®çµæœã«ã¾ã£ãŸãæº€è¶³ã—ã¦ã„ãªã„ï¼</div><div class="mode-slot"></div></div>
    </div>
  
  </main>
</div>

<script>
const DATA = {
  "b1-1": { hint:"ã€Œã»ã¨ã‚“ã©ã€œãªã„ã€ï¼‹æ•°ãˆã‚‰ã‚Œã‚‹åè© â†’ few + è¤‡æ•°åè©", answer:"Few people in our office know he is going to resign.", explain:"few ã¯æ•°ãˆã‚‰ã‚Œã‚‹åè©ã®å‰ã«ç½®ãã€ã€Œ(æ•°ãŒ)ã»ã¨ã‚“ã©ï½ãªã„ã€ã¨ã„ã†å¦å®šçš„æ„å‘³ã€‚ä¸å¯ç®—åè©ãªã‚‰ littleã€‚", jp:"ç§ãŸã¡ã®ä¼šç¤¾ã§å½¼ãŒè¾è·ã™ã‚‹ã“ã¨ã‚’çŸ¥ã£ã¦ã„ã‚‹äººã¯ã»ã¨ã‚“ã©ã„ãªã„ã€‚" },
  "b1-2": { hint:"ã€Œãƒ”ã‚¢ãƒãŒä¸Šæ‰‹ã€ï¼ good at piano ã˜ã‚ƒãªãã€Œã‚ˆã„ãƒ”ã‚¢ãƒã®å¼¾ãæ‰‹ã€", answer:"Kazuya is a good pianist.", explain:"ã€ˆå½¢å®¹è©ï¼‹åè©(ï¼å‹•ä½œè€…)ã€‰ã®å½¢ã§è¡¨ã™ã¨è‡ªç„¶ã€‚", jp:"ã‚«ã‚ºãƒ¤ã¯ãƒ”ã‚¢ãƒãŒä¸Šæ‰‹ã§ã™ã€‚" },
  "b1-3": { hint:"å¦å®šæ–‡ã®ã€Œã€œã‚‚ã¾ãŸâ€¦ãªã„ã€â†’ not ã€œ either", answer:"If Dick doesnâ€™t go to the festival, I wonâ€™t, either.", explain:"å…ˆè¡Œã™ã‚‹å¦å®šæ–‡ã‚’å—ã‘ã¦ã€Œï½ã‚‚ã¾ãŸâ€¦ã§ãªã„ã€ã¯ not ï½ eitherã€‚", jp:"ã‚‚ã—ãƒ‡ã‚£ãƒƒã‚¯ãŒãã®ç¥­ã‚Šã«è¡Œã‹ãªã„ãªã‚‰ã€åƒ•ã‚‚è¡Œã‹ãªã„ã€‚" },
  "b1-4": { hint:"ã€Œã‚ˆãä¼‘ã‚€ã€â†’ have a good rest", answer:"Did you have a good rest during the holidays?", explain:"ã€Œã‚ˆã„ä¼‘ã¿ã‚’ã¨ã‚‹ã€ã¨è€ƒãˆ ã€ˆå‹•è©ï¼‹å½¢å®¹è©ï¼‹åè©ã€‰ã§è¡¨ã™ã€‚", jp:"ä¼‘æš‡ä¸­ã¯ã‚ˆãä¼‘ã‚ã¾ã—ãŸã‹ã€‚" },
  "b1-5": { hint:"ã€Œã‚ã£ãŸã«ã€œãªã„ã€â†’ seldom / rarely", answer:"The writer seldom appears in public.", explain:"seldom/rarely ã¯é »åº¦ãŒéå¸¸ã«ä½ã„ï¼ã»ã¼å¦å®šã€‚", jp:"ãã®ä½œå®¶ã¯ã‚ã£ãŸã«äººå‰ã«å§¿ã‚’è¦‹ã›ãªã„ã€‚" },
  "b2-1": { hint:"ã€Œæœ€ã‚‚ã€œã—ãã†ã«ãªã„äººã€â†’ the last person to ã€œ", answer:"Ben would be the last person to betray us.", explain:"be unlikely to ã€œ ã®è‡ªç„¶ãªè¨€ã„æ›ãˆã€‚", jp:"" },
  "b2-2": { hint:"that ghosts exist ã‚’åè©åŒ– â†’ existence of ghosts", answer:"Some people are sure of the existence of ghosts.", explain:"ç¯€ã®å†…å®¹ã¯åè©æ§‹æ–‡ã«ã§ãã‚‹ã€‚", jp:"" },
  "b2-3": { hint:"not ã€œ any of ... = none of ...", answer:"I like none of these pictures.", explain:"none of + è¤‡æ•°åè© ã§å…¨ä½“å¦å®šã€‚", jp:"" },
  "b2-4": { hint:"ã€Œã€œã•ã›ã‚‹ã€â†’ make + O + åŸå½¢", answer:"What made him change his mind?", explain:"Why? ã‚’ What made him ... ã«å¤‰ãˆã‚‹ã€‚", jp:"" },
  "b2-5": { hint:"only = nothing but", answer:"What you are saying is nothing but an armchair theory.", explain:"nothing but ï¼ã€ŒãŸã ã€œã«ã™ããªã„ã€ã€‚", jp:"" },
  "b2-6": { hint:"å½¢å®¹è© + though/as S V", answer:"Tired though they were, they went on working late.", explain:"è­²æ­©ã®å€’ç½®æ§‹æ–‡ã€‚", jp:"" },
  "b3-1": { hint:"", answer:"ç§ã¯ã‚ˆãå›³æ›¸é¤¨ã¸è¡Œãã—ï¼Œç§ã®å…„[å¼Ÿ]ã‚‚ã‚ˆãè¡Œãï¼", explain:"so + V + S ã§ã€ŒSã‚‚ã¾ãŸã€œã™ã‚‹ã€ã€‚", jp:"" },
  "b3-2": { hint:"", answer:"è£•ç¦ã§ã¯ãªã„ã‹ã‚‰ã¨ã„ã£ã¦äººã‚’è»½ã¹ã¤ã™ã¹ãã§ã¯ãªã„ï¼", explain:"because ç¯€ã ã‘ã‚’å¦å®šã™ã‚‹å½¢ã€‚", jp:"" },
  "b3-3": { hint:"", answer:"è…¹ãŒç«‹ã£ãŸã‚‰ï¼Œè©±ã™å‰ã«10æ•°ãˆãªã•ã„ï¼", explain:"When (you are) angry ã®çœç•¥ã€‚", jp:"" },
  "b3-4": { hint:"", answer:"ç§ãŸã¡ã¯ã“ã“ã§å½¼ã‚’å¾…ã¤ã—ã‹ãªã„ï¼", explain:"have no choice but to do ï¼ã€Œã€œã™ã‚‹ã—ã‹ãªã„ã€ã€‚", jp:"" },
  "b3-5": { hint:"", answer:"ã“ã®ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®ãŠã‹ã’ã§ç§ãŸã¡ã¯æ™‚é–“ã¨åŠ´åŠ›ã‚’çœãã“ã¨ãŒã§ãã‚‹ï¼", explain:"save O1 O2 ã®ç¬¬4æ–‡å‹ã€‚", jp:"" },
  "b4-1": { hint:"be sorry for not -ing", answer:"Iâ€™m sorry for not introducing myself sooner.", explain:"å¦å®šèª not ã¯å¦å®šã—ãŸã„èªå¥ã®ç›´å‰ã€‚", jp:"" },
  "b4-2": { hint:"It is ï½ that ... ã®å¼·èª¿æ§‹æ–‡ã€‚", answer:"It was this glass slipper that Cinderella wore at the ball.", explain:"å¼·èª¿ã—ãŸã„èªå¥ã‚’ It was ã¨ that ã®é–“ã¸ã€‚", jp:"" },
  "b4-3": { hint:"not ... any longer", answer:"I cannot stand the cold any longer.", explain:"ã€Œã‚‚ã¯ã‚„ã€œãªã„ã€ã€‚", jp:"" },
  "b4-4": { hint:"remind A of B", answer:"Your T-shirt reminds me of my country.", explain:"A remind B of ã€œã€‚", jp:"" },
  "b5-1": { hint:"enable O to do", answer:"The scholarship enabled him to go to university.", explain:"ç„¡ç”Ÿç‰©ä¸»èªã§ã€Œã€œã®ãŠã‹ã’ã§OãŒã§ãã‚‹ã€ã€‚", jp:"" },
  "b5-2": { hint:"Never ã‚’æ–‡é ­â†’å€’ç½®", answer:"Never have I seen such a beautiful sight.", explain:"å¦å®šå‰¯è©å‰ç½®ã§åŠ©å‹•è©å€’ç½®ã€‚", jp:"" },
  "b5-3": { hint:"Her letter says that ...", answer:"Her letter says (that) she will come back to Japan next week.", explain:"say/tell ã®ç„¡ç”Ÿç‰©ä¸»èªç”¨æ³•ã€‚", jp:"" },
  "b5-4": { hint:"neither + V + S", answer:"My father doesnâ€™t smoke, and neither do I.", explain:"å¦å®šå†…å®¹ã‚’å—ã‘ã‚‹å€’ç½®ã€‚", jp:"" },
  "b5-5": { hint:"the rumor that ...", answer:"Have you heard the rumor that they will get married?", explain:"åŒæ ¼ã® that ç¯€ã€‚", jp:"" },
  "fc-1": { hint:"", answer:"b. I hope not.", explain:"æœ›ã¾ã—ããªã„ã“ã¨ã«ã€Œãã†ã§ãªã„ã¨ã„ã„ã€ã€‚", jp:"" },
  "fc-2": { hint:"", answer:"a. No kidding.", explain:"é©šãã€Œã¾ã•ã‹ï¼ã€ã€‚", jp:"" },
  "a1-1": { hint:"beyond my control", answer:"d. beyond", explain:"ã€ŒåŠã°ãªã„ã€ï¼ beyondã€‚", jp:"" },
  "a1-2": { hint:"not ã€œ either", answer:"b. either", explain:"å¦å®šï¼‹ã€Œã€œã‚‚ã¾ãŸã€ã€‚", jp:"" },
  "a1-3": { hint:"anything but", answer:"a. anything", explain:"anything but perfectã€Œæ±ºã—ã¦å®Œå…¨ã§ãªã„ã€ã€‚", jp:"" },
  "a1-4": { hint:"enable O to do", answer:"d. enabled", explain:"enable ã®éå»åˆ†è©ã€‚", jp:"" },
  "a1-5": { hint:"far from", answer:"d. far", explain:"far from satisfyingã€‚", jp:"" },
  "a1-6": { hint:"How in the world", answer:"b. world", explain:"ç–‘å•å¼·èª¿ã®æ…£ç”¨å¥ã€‚", jp:"" },
  "a2-1": { hint:"When was it that ...?", answer:"When was it that you heard from your brother?", explain:"å¼·èª¿æ§‹æ–‡ã®ç–‘å•å½¢ã€‚", jp:"" },
  "a2-2": { hint:"never ã€œ without ...ing", answer:"I never hear that story without remembering him.", explain:"äºŒé‡å¦å®šã§ã€Œå¿…ãšã€ã€‚", jp:"" },
  "a2-3": { hint:"not ã€œ until ...", answer:"You donâ€™t appreciate your own country until you leave it.", explain:"ã€Œâ€¦ã—ã¦åˆã‚ã¦ã€ã€‚", jp:"" },
  "a2-4": { hint:"S will make O do", answer:"A little reflection will make you realize you are wrong.", explain:"make O do æ§‹æ–‡ã€‚", jp:"" },
  "a3-1": { hint:"prevent O from -ing", answer:"A snow storm prevented her from going to school.", explain:"ã€Œã€œã®ãŸã‚ã«è¡Œã‘ãªã„ã€â†’ preventã€‚", jp:"" },
  "a3-2": { hint:"not ã€œ at all", answer:"I am not satisfied with the result at all.", explain:"å¦å®šã‚’å¼·ã‚ã‚‹å‰¯è©å¥ã€‚", jp:"" }
};

let mode = "A";
const modeBtn = document.getElementById("modeBtn");
const modeDesc = document.getElementById("modeDesc");
const renderedAnswers = new Set();

/* scheduler */
const idle = (fn)=>(
  "requestIdleCallback" in window
    ? requestIdleCallback(fn, {timeout: 200})
    : setTimeout(fn, 0)
);

/* utilities */
function hintText(d){
  return d.hint && d.hint.trim()
    ? d.hint
    : "ã“ã®å•é¡Œã¯ãƒ’ãƒ³ãƒˆãªã—ã€‚ã¾ãšè‡ªåŠ›ã§è§£ã„ã¦ã¿ã‚ˆã†ã€‚å¿…è¦ãªã‚‰è§£ç­”ã‚’é–‹ã„ã¦ç¢ºèªï¼";
}
function buildHintBody(qid){
  const d = DATA[qid] || {};
  const noHint = (!d.hint || !d.hint.trim());
  return `
    <div class="accordion bubble-wrap hint ${noHint?'warn':''}" data-box="hint">
      <div class="accordion-inner bubble hint ${noHint?'warn':''}">
        <div class="label">ğŸ’¡ HINT</div>
        <div>${hintText(d)}</div>
      </div>
    </div>`;
}
function buildAnswerBody(qid){
  const d = DATA[qid] || {};
  return `
    <div class="accordion bubble-wrap answer" data-box="answer">
      <div class="accordion-inner bubble answer">
        <div class="label">âœ… ANSWER</div>
        <div><b>${d.answer||""}</b></div>
        ${d.explain?`<div style="margin-top:6px;">${d.explain}</div>`:""}
        ${d.jp?`<div class="jp">å’Œè¨³ï¼š${d.jp}</div>`:""}
      </div>
    </div>`;
}

/* render shells */
function renderModeAShell(slot, qid){
  const d = DATA[qid] || {};
  const noHint = (!d.hint || !d.hint.trim());
  slot.innerHTML = `
    <div class="toggle-row">
      <button class="mini hint ${noHint?'warn':''}" data-action="hint">ğŸ’¡ Hint ${noHint?'<span class="hintless-note">no hint</span>':''}</button>
      <button class="mini answer" data-action="answer">âœ… Answer</button>
    </div>
    <div class="ex" data-ex></div>
  `;
}
function renderModeBShell(slot, qid){
  const d = DATA[qid] || {};
  const noHint = (!d.hint || !d.hint.trim());
  slot.innerHTML = `
    <div class="qa-split" data-split>
      <div class="qa-box hint ${noHint?'warn':''}">
        <div class="qa-head">
          <span>ğŸ’¡ HINT ${noHint?'<span class="hintless-note">no hint</span>':''}</span>
          <button class="mini hint ${noHint?'warn':''}" data-action="hint">Open</button>
        </div>
        <div class="accordion qa-acc hint ${noHint?'warn':''}">
          <div class="accordion-inner qa-body hint ${noHint?'warn':''}" data-hint-body></div>
        </div>
      </div>
      <div class="qa-box answer">
        <div class="qa-head">
          <span>âœ… ANSWER</span>
          <button class="mini answer" data-action="answer">Open</button>
        </div>
        <div class="accordion qa-acc answer">
          <div class="accordion-inner qa-body answer" data-answer-body></div>
        </div>
      </div>
    </div>
  `;
}

/* answer injection on click */
function injectAnswerIfNeeded(item){
  const qid=item.dataset.qid;
  if(renderedAnswers.has(qid)) return;

  if(mode==="A"){
    const ex=item.querySelector("[data-ex]");
    if(ex){
      if(!ex.querySelector(".bubble-wrap.hint")) ex.insertAdjacentHTML("beforeend", buildHintBody(qid));
      ex.insertAdjacentHTML("beforeend", buildAnswerBody(qid));
    }
  }else{
    const hintBody=item.querySelector("[data-hint-body]");
    const answerBody=item.querySelector("[data-answer-body]");
    if(hintBody && !hintBody.innerHTML) hintBody.innerHTML = hintText(DATA[qid]||{});
    if(answerBody){
      const d=DATA[qid]||{};
      answerBody.innerHTML = `
        <div><b>${d.answer||""}</b></div>
        ${d.explain?`<div style="margin-top:6px;">${d.explain}</div>`:""}
        ${d.jp?`<div class="jp">å’Œè¨³ï¼š${d.jp}</div>`:""}
      `;
    }
  }
  renderedAnswers.add(qid);
}

/* toggle wiring */
function setupToggles(item){
  item.querySelectorAll(".mini[data-action]").forEach(btn=>{
    btn.onclick = ()=>{
      const action=btn.dataset.action;
      const qid=item.dataset.qid;

      if(mode==="A"){
        const ex=item.querySelector("[data-ex]");
        if(action==="hint"){
          if(ex && !ex.querySelector(".bubble-wrap.hint")) ex.insertAdjacentHTML("afterbegin", buildHintBody(qid));
          const acc=item.querySelector(".bubble-wrap.hint");
          if(acc) acc.classList.toggle("open");
        }else{
          injectAnswerIfNeeded(item);
          const acc=item.querySelector(".bubble-wrap.answer");
          if(acc) acc.classList.toggle("open");
        }
      }else{
        if(action==="hint"){
          const hintBody=item.querySelector("[data-hint-body]");
          if(hintBody && !hintBody.innerHTML) hintBody.innerHTML = hintText(DATA[qid]||{});
          const acc=item.querySelector(".qa-box.hint .qa-acc");
          if(acc) acc.classList.toggle("open");
          btn.textContent=acc.classList.contains("open")?"Close":"Open";
        }else{
          injectAnswerIfNeeded(item);
          const acc=item.querySelector(".qa-box.answer .qa-acc");
          if(acc) acc.classList.toggle("open");
          btn.textContent=acc.classList.contains("open")?"Close":"Open";
        }
      }
    };
  });
}

/* ===== FULL QUESTION VIRTUALIZATION (v9) =====
   Upgrades:
   1) Pre-measure all heights once (hidden pass) for perfect placeholders.
   2) Restore only after scroll-idle (no mid-fling work).
   3) Bigger overscan band to avoid placeholder flashes.
   4) Freeze heavy paint during active scroll via body.scrolling.
*/
const items = [...document.querySelectorAll(".q-item[data-qid]")];
const heightCache = new Map();
const liveSet = new Set();

function makePlaceholder(item){
  if(item.classList.contains("virtual")) return;
  const qid=item.dataset.qid;
  const h = heightCache.get(qid) || item.getBoundingClientRect().height || 140;
  heightCache.set(qid, h);

  const rectBefore = item.getBoundingClientRect();
  const html = item.dataset._html || item.outerHTML;
  item.dataset._html = html;

  const ph=document.createElement("div");
  ph.className="q-placeholder virtual";
  ph.dataset.qid=qid;
  ph.dataset._html = html;
  ph.style.height = h+"px";
  ph.innerHTML = `
      <div class="sk-chip"></div>
      <div class="sk-line wide"></div>
      <div class="sk-line mid"></div>
      <div class="sk-line short"></div>
      <div style="font-weight:800;letter-spacing:.03em;margin-top:2px;">
        Loading questionâ€¦
      </div>
  `;
  item.replaceWith(ph);

  // compensate scroll if swapped above viewport
  const rectAfter = ph.getBoundingClientRect();
  const delta = rectAfter.top - rectBefore.top;
  if(Math.abs(delta)>1 && rectBefore.top < 0){
    window.scrollBy(0, delta);
  }
  liveSet.delete(qid);
}

function restoreItem(ph){
  const qid=ph.dataset.qid;
  if(!ph.classList.contains("virtual")) return;
  const rectBefore = ph.getBoundingClientRect();

  const wrap=document.createElement("div");
  wrap.innerHTML = ph.dataset._html || "";
  const item=wrap.firstElementChild;
  if(!item){ return; }

  ph.replaceWith(item);

  const slot=item.querySelector(".mode-slot");
  if(slot){
    slot.innerHTML="";
    if(mode==="A") renderModeAShell(slot,qid);
    else renderModeBShell(slot,qid);
  }
  setupToggles(item);

  const rectAfter = item.getBoundingClientRect();
  const delta = rectAfter.top - rectBefore.top;
  if(Math.abs(delta)>1 && rectBefore.top < 0){
    window.scrollBy(0, delta);
  }
  liveSet.add(qid);
}

/* Scroll-idle gate */
let scrollingTimer=null;
let isScrolling=false;
function onScrollStart(){
  if(!isScrolling){
    isScrolling=true;
    document.body.classList.add("scrolling");
  }
  clearTimeout(scrollingTimer);
  scrollingTimer=setTimeout(()=>{
    isScrolling=false;
    document.body.classList.remove("scrolling");
    // after idle, restore nearby placeholders
    restoreNearPlaceholders();
  }, 110);
}
window.addEventListener("scroll", onScrollStart, {passive:true});

/* Restore near placeholders after scroll idle */
function restoreNearPlaceholders(){
  const bandTop = -innerHeight*1.2;
  const bandBottom = innerHeight*2.2;
  document.querySelectorAll(".q-placeholder.virtual").forEach(ph=>{
    const r=ph.getBoundingClientRect();
    if(r.bottom>bandTop && r.top<bandBottom){
      idle(()=>restoreItem(ph));
    }
  });
}

/* IntersectionObserver with bigger overscan */
function initVirtualization(){
  // store original html for each item
  items.forEach(it=>{
    it.dataset._html = it.outerHTML;
  });

  const io = new IntersectionObserver(entries=>{
    entries.forEach(e=>{
      const target=e.target;
      if(target.classList.contains("q-item")){
        const qid=target.dataset.qid;
        if(e.isIntersecting){
          liveSet.add(qid);
        }else{
          const rect=target.getBoundingClientRect();
          const far = rect.top > innerHeight*3.2 || rect.bottom < -innerHeight*3.2;
          if(far){
            idle(()=>makePlaceholder(target));
          }
        }
      }else if(target.classList.contains("q-placeholder")){
        // don't restore mid-scroll; wait for idle
        if(e.isIntersecting && !isScrolling){
          idle(()=>restoreItem(target));
        }
      }
    });
  }, { rootMargin:"1400px 0px", threshold:0.01 });

  const observeAll=()=>{
    document.querySelectorAll(".q-item[data-qid], .q-placeholder.virtual").forEach(n=>{
      if(!n._observed){
        n._observed=true;
        io.observe(n);
      }
      if(n.classList.contains("q-placeholder") && !n.dataset._html){
        const qid=n.dataset.qid;
        n.dataset._html = items.find(i=>i.dataset.qid===qid)?.dataset._html || "";
        n.style.height = (heightCache.get(qid) || 140)+"px";
      }
    });
  };
  observeAll();
  setInterval(observeAll, 600);

  // initial pass: virtualize far items right away
  idle(()=>{
    document.querySelectorAll(".q-item[data-qid]").forEach(it=>{
      const rect=it.getBoundingClientRect();
      const far = rect.top > innerHeight*2.4 || rect.bottom < -innerHeight*2.4;
      if(far) makePlaceholder(it);
    });
  });
}

/* Pre-measure heights once (hidden pass) */
function preMeasureHeights(){
  const measurer=document.createElement("div");
  measurer.style.cssText="position:absolute;left:-99999px;top:0;width:calc(100% - 20px);visibility:hidden;pointer-events:none;";
  document.body.appendChild(measurer);
  items.forEach(it=>{
    const clone=it.cloneNode(true);
    clone.style.height="auto";
    clone.querySelectorAll(".mode-slot").forEach(s=>s.innerHTML=""); // no extra content
    measurer.appendChild(clone);
    const h=clone.getBoundingClientRect().height || 140;
    heightCache.set(clone.dataset.qid, h);
  });
  measurer.remove();
}

/* Mode rebuild for live questions */
function rebuildAllLive(){
  renderedAnswers.clear();
  document.querySelectorAll(".q-item[data-qid]").forEach(item=>{
    const qid=item.dataset.qid;
    const slot=item.querySelector(".mode-slot");
    if(slot){
      slot.innerHTML="";
      if(mode==="A") renderModeAShell(slot,qid);
      else renderModeBShell(slot,qid);
    }
    setupToggles(item);
  });
  document.querySelectorAll(".q-placeholder.virtual").forEach(ph=>{
    ph.style.height=(heightCache.get(ph.dataset.qid)||140)+"px";
  });
}

modeBtn.addEventListener("click", ()=>{
  mode = (mode==="A") ? "B" : "A";
  modeDesc.textContent = mode==="A"
    ? "Mode A: stacked Hint/Answer accordions."
    : "Mode B: split Hint/Answer row under each question.";
  modeBtn.textContent = mode==="A" ? "ğŸ…°ï¸ Mode A" : "ğŸ…±ï¸ Mode B";
  rebuildAllLive();
});

document.getElementById("collapseAllBtn").addEventListener("click", ()=>{
  document.querySelectorAll(".accordion.open").forEach(a=>a.classList.remove("open"));
  document.querySelectorAll(".mini[data-action='hint'], .mini[data-action='answer']").forEach(btn=>{
    if(mode==="B") btn.textContent="Open";
  });
});

document.getElementById("themeBtn").addEventListener("click", ()=>{
  document.body.classList.toggle("dark");
});

document.getElementById("downloadBtn").addEventListener("click", ()=>{
  const fullHtml="<!DOCTYPE html>\n"+document.documentElement.outerHTML;
  const blob=new Blob([fullHtml],{type:"text/html"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="grammar_breakdown_14_singlecol_2modes_ULTRALITE_v9_FULLVIRT_NOTESGRAY_MAXSMOOTH.html";
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
});

/* init shells for visible items */
document.querySelectorAll(".q-item[data-qid]").forEach(item=>{
  const qid=item.dataset.qid;
  const slot=item.querySelector(".mode-slot");
  if(slot){
    if(mode==="A") renderModeAShell(slot,qid);
    else renderModeBShell(slot,qid);
  }
  setupToggles(item);
});

preMeasureHeights();
initVirtualization();
</script>
</body>
</html>
